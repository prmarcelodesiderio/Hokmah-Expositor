<header style="display:flex; gap:10px; align-items:center;">
  <strong>Hokmah Expositor</strong>
  <span id="badge" style="margin-left:auto; padding:2px 8px; border:1px solid #999; border-radius:6px;">Plano: Free</span>
  <button id="assinar" type="button">Assinar Premium</button>
  <button id="gerenciar" style="display:none">Gerenciar assinatura</button>
</header>

<hr/>

<section id="free">Conte√∫do gr√°tis vis√≠vel para todos.</section>
<section id="premium" style="display:none">
  <h3>üéâ Conte√∫do Premium liberado!</h3>
  <p>Aqui ficam as fun√ß√µes/recursos para assinantes.</p>
</section>

<script type="module">
  /********** 1) Firebase SDK (preencha seu config) **********/
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
  import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

  const firebaseConfig = {
   // Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
import { getAnalytics } from "firebase/analytics";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyCkJgMgiz89Ra-GglXXolEf76Bf8j43deU",
  authDomain: "gen-lang-client-0187133986.firebaseapp.com",
  projectId: "gen-lang-client-0187133986",
  storageBucket: "gen-lang-client-0187133986.firebasestorage.app",
  messagingSenderId: "467345148998",
  appId: "1:467345148998:web:f220bd5382cccf4cb94e47",
  measurementId: "G-MLQ617DL87"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();
const db   = getFirestore(app);


  /********** 2) Refer√™ncias de UI **********/
  const badge     = document.getElementById('badge');
  
 //************ 4) Endpoints do Cloud Run ************/
const CLOUD_RUN_BASE = 'https://create-checkout-session-467345148998.europe-west1.run.app'; // sua URL base (sem barra no final)
const CHECKOUT_URL   = `${CLOUD_RUN_BASE}/create-checkout-session`;
const PORTAL_URL     = `${CLOUD_RUN_BASE}/billing-portal`;

//************ 5) Handlers dos bot√µes ************/
async function irParaCheckout(uid) {
   console.log('[APP] irParaCheckout()', { uid, CHECKOUT_URL });

  try {
    const resp = await fetch(CHECKOUT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        uid, // seu UID logado
        priceId: 'price_1SOTjHA0f0MY0usftoft1YRd', // confirme seu price do Stripe
        success_url: window.location.origin + '/sucesso.html',
        cancel_url:  window.location.origin + '/cancelado.html',
      }),
    });

    const data = await resp.json().catch(() => ({}));
    console.log('[APP] resposta checkout:', resp.status, data);

    if (!resp.ok) {
      throw new Error((data?.error || `HTTP ${resp.status}`));
    }

    if (data?.url) {
      window.location.href = data.url; // redireciona para o Stripe
    } else {
      alert('Resposta inv√°lida do backend (sem url).');
    }
  } catch (e) {
    console.error(e);
    alert('Falha ao criar sess√£o de checkout: ' + e.message);
  }
}

  try {
    const resp = await fetch(CHECKOUT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        uid,                              // seu UID logado
        priceId: price_1SOTjHA0f0MY0usftoft1YRd,     // ajuste para o seu price do Stripe
        success_url: window.location.origin + "/sucesso.html",
        cancel_url: window.location.origin + "/cancelado.html",
      })
    });

// ===== Aguarda o DOM ficar pronto antes de ligar a UI =====
// ...
// (Fun√ß√£o irParaCheckout termina na linha 93)
// ...

document.addEventListener('DOMContentLoaded', () => {
    console.log('[APP] DOM pronto');

    // 1) Refer√™ncia dos bot√µes (aqui √© o lugar certo)
    const btnAssinar = document.getElementById('btnAssinar');
    const btnGerenciar = document.getElementById('gerenciar'); // Corrija o ID se for 'btnGerenciar'

    if (!btnAssinar) {
        console.error('[APP] Bot√£o "btnAssinar" n√£o encontrado no DOM!');
    }
    if (!btnGerenciar) {
        console.error('[APP] Bot√£o "btnGerenciar" n√£o encontrado no DOM!');
    }

    // 2) Handler do clique "Assinar"
    if (btnAssinar) {
        btnAssinar.addEventListener('click', async (ev) => {
            ev.preventDefault(); // <-- Importante!
            console.log('[APP] Click ASSINAR');
            
            try {
                let user = auth.currentUser;
                // Se n√£o estiver logado, abre login com Google
                if (!user) {
                    await signInWithPopup(auth, provider);
                    user = auth.currentUser; // Pega o usu√°rio rec√©m-logado
                    console.log('[APP] Login OK:', user.uid);
                }
                
                // Se o login foi feito ou j√° estava logado, chama o checkout
                if (user) {
                    await irParaCheckout(user.uid);
                }
            } catch (e) {
                console.error(e);
                alert("Erro no fluxo de assinatura: " + e.message);
            }
        });
    }

    // 3) Handler do bot√£o "Gerenciar"
    if (btnGerenciar) {
        btnGerenciar.addEventListener('click', async (ev) => {
            ev.preventDefault(); // <-- Importante!
            console.log('[APP] Click GERENCIAR');
            
            try {
                let user = auth.currentUser;
                // Se n√£o estiver logado, abre login com Google
                if (!user) {
                    await signInWithPopup(auth, provider);
                    user = auth.currentUser; // Pega o usu√°rio rec√©m-logado
                }

                // Se o login foi feito ou j√° estava logado, abre o portal
                if (user) {
                    await abrirPortal(user.uid);
                }
            } catch (e) {
                console.error(e);
                alert("Falha ao abrir portal de cobran√ßa: " + e.message);
            }
        });
    }
});

// Handler do bot√£o "Gerenciar"
btnGerenciar.addEventListener('click', async (ev) => {
  ev.preventDefault(); // <‚Äî importante!
  console.log('[APP] CLICK GERENCIAR');

  try {
    if (!auth.currentUser) {
      try { await signInWithPopup(auth, provider); } catch(e){ return alert('Login cancelado.'); }
    }
    await abrirPortal(auth.currentUser.uid);
  } catch (e) {
    console.error(e);
    alert('Falha ao abrir portal de cobran√ßa: ' + (e?.message || e));
  }
});

   
    if (!resp.ok) {
      const err = await resp.json().catch(() => ({}));
      throw new Error(err.error || `HTTP ${resp.status}`);
    }

    // O backend pode devolver { url: 'https://checkout.stripe.com/...' }
    const data = await resp.json();
    if (data.url) window.location.href = data.url;
  } catch (e) {
    alert("Falha ao criar sess√£o de checkout: " + e.message);
  }
}

async function abrirPortal(uid) {
  try {
    const resp = await fetch(PORTAL_URL + `?uid=${encodeURIComponent(uid)}`);
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    const data = await resp.json();
    if (data.url) window.location.href = data.url;
  } catch (e) {
    alert("Falha ao abrir portal de cobran√ßa: " + e.message);
  }
}

/************ 6) Autentica√ß√£o + gating (com login no clique) ************/
const livre        = document.getElementById('free');
const premium      = document.getElementById('premium');
const btnAssinar   = document.getElementById('assinar');
const btnGerenciar = document.getElementById('gerenciar');
const badge        = document.getElementById('badge'); // se existir

/*
// Handlers SEMPRE ligados
  if (!auth.currentUser) {
    try { await signInWithPopup(auth, provider); }
    catch(e) { return alert('Login cancelado.'); }
  }
  await irParaCheckout(auth.currentUser.uid);
};

  if (!auth.currentUser) {
    try { await signInWithPopup(auth, provider); }
    catch(e) { return alert('Login cancelado.'); }
  }
  await abrirPortal(auth.currentUser.uid);
};
*/

// ...
// (Fun√ß√£o abrirPortal(uid) termina na linha 176)
// ...

onAuthStateChanged(auth, (user) => {
    // 6) Autentica√ß√£o e gating (agora s√≥ atualiza a UI)
    const livre = document.getElementById('free');
    const premium = document.getElementById('premium');
    const btnAssinar = document.getElementById('btnAssinar');
    const btnGerenciar = document.getElementById('gerenciar');
    const badge = document.getElementById('badge'); // se existir

    // Visitante
    if (!user) {
        if (badge) badge.textContent = 'Plano: Free';
        livre.style.display = '';
        premium.style.display = 'none';
        btnAssinar.style.display = '';
        btnGerenciar.style.display = 'none';
        return;
    }

    // Logado: acompanha plano no Firestore
    const ref = doc(db, "users", user.uid);
    onSnapshot(ref, (snap) => {
        if (!snap.data()) { /* usu√°rio sem doc? */ return; }
        
        const u = snap.data().u;
        const constAtivo = u.status_assinatura === "ativo" || u.subscriptionStatus === "active";
        const constPremium = ativo || u.plan === 'premium' || u.plan === 'pro';

        if (badge) badge.textContent = constPremium ? 'Plano: Premium' : 'Plano: Free';
        
        livre.style.display = constPremium ? 'none' : '';
        premium.style.display = constPremium ? '' : 'none';
        btnAssinar.style.display = constPremium ? 'none' : '';
        btnGerenciar.style.display = constPremium ? '' : 'none';
    });
});



